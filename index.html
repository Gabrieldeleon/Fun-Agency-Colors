<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tu equipo</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .wrap {
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px;
    }
    .card {
      background: rgba(255,255,255,0.14);
      border-radius: 20px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      padding: 28px 32px;
      max-width: 720px;
      width: 100%;
      box-shadow: 0 8px 30px rgba(0,0,0,0.18);
    }
    h1 {
      font-size: clamp(42px, 7vw, 80px);
      line-height: 1.05;
      margin: 0 0 12px 0;
      letter-spacing: -0.02em;
    }
    p {
      margin: 0.5rem 0;
      font-size: clamp(16px, 2.6vw, 22px);
      opacity: 0.9;
    }
    .muted { 
      opacity: 0.75; 
      font-size: 14px; 
    }
    .loading {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="teamTitle" class="loading">Asignando…</h1>
      <p id="teamHint">Espera un segundo</p>
      <p class="muted" id="footnote"></p>
    </div>
  </div>

<script>
(async function(){
  const colorMap = {
    'Rojo': '#e53935',
    'Azul': '#1e88e5',
    'Verde': '#43a047',
    'Amarillo': '#fdd835',
    'Naranja': '#fb8c00',
    'Morado': '#8e24aa',
    'Gris': '#9e9e9e'
  };

  function idealTextColor(bgHex){
    function hexToRgb(h){
      let s = h.replace('#','');
      if (s.length === 3) s = s.split('').map(x=>x+x).join('');
      const num = parseInt(s, 16);
      return {r:(num>>16)&255, g:(num>>8)&255, b:num&255};
    }
    const {r,g,b} = hexToRgb(bgHex);
    const yiq = (r*299 + g*587 + b*114) / 1000;
    return yiq >= 140 ? '#000' : '#fff';
  }

  // Generate a unique user ID based on browser and time
  function generateUserId() {
    const stored = localStorage.getItem('teamAppUserId');
    if (stored) return stored;
    
    const id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('teamAppUserId', id);
    return id;
  }

  // Replace with your actual Apps Script URL
  const apiUrl = "https://script.google.com/macros/s/AKfycbxCR0peJ-9Vf2j9ZAY7RY7neahvUpuyOXrWBxiPHDvvNhzqfDRP94slEnSTT4-bdKI/exec";

  try {
    const userId = generateUserId();
    
    // First, try to get existing assignment
    const checkResponse = await fetch(`${apiUrl}?action=getPersona&id=${encodeURIComponent(userId)}`);
    
    let assignedColor = null;
    
    if (checkResponse.ok) {
      const checkData = await checkResponse.json();
      if (checkData.color && !checkData.error) {
        assignedColor = checkData.color;
      }
    }
    
    // If no existing assignment, request a new one
    if (!assignedColor) {
      const assignResponse = await fetch(`${apiUrl}?action=assignColor&id=${encodeURIComponent(userId)}`);
      
      if (!assignResponse.ok) {
        throw new Error(`HTTP error! status: ${assignResponse.status}`);
      }
      
      const assignData = await assignResponse.json();
      
      if (assignData.error) {
        throw new Error(assignData.error);
      }
      
      assignedColor = assignData.color;
    }
    
    if (!assignedColor) {
      throw new Error('No se pudo obtener el color asignado');
    }

    // Apply the color theme
    const bgColor = colorMap[assignedColor] || "#9e9e9e";
    const textColor = idealTextColor(bgColor);

    document.body.style.background = bgColor;
    document.body.style.color = textColor;
    document.getElementById("teamTitle").textContent = "Tu color: " + assignedColor;
    document.getElementById("teamTitle").classList.remove("loading");
    document.getElementById("teamHint").textContent = "Muestra esta pantalla al staff";
    document.getElementById("footnote").textContent = "ID: " + userId.substr(-8);

  } catch (err) {
    console.error("Error fetching color:", err);
    document.getElementById("teamTitle").textContent = "Error";
    document.getElementById("teamTitle").classList.remove("loading");
    document.getElementById("teamHint").textContent = "No se pudo obtener el color: " + err.message;
    document.getElementById("footnote").textContent = "Intenta recargar la página";
  }
})();
</script>
</body>
</html>
